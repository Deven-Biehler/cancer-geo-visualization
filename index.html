<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pie Chart Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <style>
        #map { height: 600px; width: 100%; }
        .pie-chart { pointer-events: auto; }
        .arc path { cursor: pointer; }
        .arc path:hover { opacity: 0.7; }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            pointer-events: none;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="tooltip" class="tooltip" style="display: none;"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([40.7128, -74.0060], 6);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Sample data
        const data = [
            { lat: 40.7128, lng: -74.0060, values: [30, 25, 20, 15, 10], labels: ['A', 'B', 'C', 'D', 'E'] },
            { lat: 42.3601, lng: -71.0589, values: [20, 30, 25, 15, 10], labels: ['A', 'B', 'C', 'D', 'E'] },
            { lat: 39.9526, lng: -75.1652, values: [25, 20, 30, 15, 10], labels: ['A', 'B', 'C', 'D', 'E'] }
        ];
        
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
        
        // Function to create pie chart at zoom level
        function createPieChart(location, zoom) {
            const baseRadius = 50;
            const minRadius = 10;
            const radius = Math.max(minRadius, baseRadius / Math.pow(2, Math.max(0, 10 - zoom)));
            const size = radius * 2 + 20;
            
            const pie = d3.pie().value(d => d);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            
            const svg = d3.create('svg')
                .attr('width', size)
                .attr('height', size)
                .attr('class', 'pie-chart');
            
            const g = svg.append('g')
                .attr('transform', `translate(${size/2}, ${size/2})`);
            
            const arcs = g.selectAll('.arc')
                .data(pie(location.values))
                .enter().append('g')
                .attr('class', 'arc');
            
            arcs.append('path')
                .attr('d', arc)
                .attr('fill', (d, i) => colors[i])
                .attr('data-label', (d, i) => location.labels[i])
                .attr('data-value', d => d.value);
            
            return {
                element: svg.node(),
                size: size
            };
        }
        
        // Store markers for updates
        const markers = [];
        
        // Create initial pie charts
        function updatePieCharts() {
            const zoom = map.getZoom();
            
            // Remove existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers.length = 0;
            
            // Add new markers with updated size
            data.forEach(location => {
                const pieData = createPieChart(location, zoom);
                
                const customIcon = L.divIcon({
                    html: pieData.element.outerHTML,
                    className: 'custom-div-icon',
                    iconSize: [pieData.size, pieData.size],
                    iconAnchor: [pieData.size/2, pieData.size/2]
                });
                
                const marker = L.marker([location.lat, location.lng], {
                    icon: customIcon
                }).addTo(map);
                
                // Add event listeners after marker is added
                setTimeout(() => {
                    const markerElement = marker.getElement();
                    const paths = markerElement.querySelectorAll('path');
                    
                    paths.forEach(path => {
                        path.addEventListener('mouseover', (event) => {
                            const tooltip = document.getElementById('tooltip');
                            const label = path.getAttribute('data-label');
                            const value = path.getAttribute('data-value');
                            tooltip.innerHTML = `${label}: ${value}`;
                            tooltip.style.display = 'block';
                            tooltip.style.left = event.pageX + 10 + 'px';
                            tooltip.style.top = event.pageY - 10 + 'px';
                        });
                        
                        path.addEventListener('mousemove', (event) => {
                            const tooltip = document.getElementById('tooltip');
                            tooltip.style.left = event.pageX + 10 + 'px';
                            tooltip.style.top = event.pageY - 10 + 'px';
                        });
                        
                        path.addEventListener('mouseout', () => {
                            document.getElementById('tooltip').style.display = 'none';
                        });
                    });
                }, 0);
                
                markers.push(marker);
            });
        }
        
        // Initial render
        updatePieCharts();
        
        // Update on zoom
        map.on('zoomend', updatePieCharts);
    </script>
</body>
</html>